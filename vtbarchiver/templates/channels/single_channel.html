{% extends 'base.html' %}

{% block title %}{{ channel_info['channel_name'] }}{% endblock %}

{% block head_links %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-sm-1"></div>

    <div class="col-sm-10">

        
        <div class="bg-light shadow mx-auto mt-4">
            <div class="row mx-0">
                <div class="col-sm-4 border-end my-4">
                    <div class="d-flex" style="height: 100%;">
                        <div style="text-align: center; margin: auto;" class="align-self-center">
                            <img src="{{ channel_info['thumb_url'] }}" class="rounded-circle" style="width: 60%;" alt="Thumb" />
                        </div>
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="d-flex px-2" style="height: 100%;">
                        <div class="align-self-center">
                            <div class="my-2"><a href="https://youtube.com/channel/{{ channel_info['channel_id'] }}" target="_blank" class="text-dark" style="text-decoration: none;"><h2>{{ channel_info['channel_name'] }}</h2></a></div>
                            <div class="my-2 text-secondary">Number of videos: {{ video_num }}</div>
                            {% if g.user %}
                                <div class="my-2 text-secondary">Download checkpoint: {{ channel_info['checkpoint_idx'] }}</div>
                            {% endif %}
                        </div>
                        {% if g.user %}
                            <div class="align-self-start flex-grow-1" style="text-align: right;">
                                <a data-bs-toggle="modal" data-bs-target="#channel-setting-modal" href="#channel-setting-modal" style="text-decoration: none;"><i class="iconfont icon-set text-secondary" style="font-size: 1.5em;"></i></a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-5">
            <ul class="nav nav-tabs justify-content-center">
                <li class="nav-item">
                  <a class="nav-link active" data-bs-toggle="tab" href="#channel-videos">Videos</a>
                </li>
                <li class="nav-item">
                  <a id="stats-tab" class="nav-link" data-bs-toggle="tab" href="#channel-stats">Statistics</a>
                </li>
            </ul>
        </div>
        
        <div class="tab-content">
            <div class="tab-pane container active" id="channel-videos">
                <div class="mt-3">
                    {% for single_video in videos_on_page %}
                        <div class="bg-light shadow-sm mx-auto my-2 border rounded-2" onclick="location.assign('{{ url_for('videos.single_video', video_id=single_video['video_id']) }}')" style="cursor: pointer;">
                            <div class="row mx-0">
                                <div class="col-sm-3 border-end px-0">
                                    <div class="mx-auto d-flex" style="text-align: center; align-items: center; height: 100%;">
                                        <img src="{{ single_video['thumb_url'] }}" style="width: 100%; display: block;" alt="Thumb" class="border-0 rounded-2"/>
                                    </div>
                                </div>
                                <div class="col-sm-9">
                                    <div class="d-flex px-2" style="height: 100%;">
                                        <div class="align-self-center pe-2">
                                            <div class="my-2">{{ single_video['title'] }}</div>
                                            <div class="my-2 text-secondary video-upload-date" style="font-size: 0.9em;">{{ single_video['upload_date'] }}</div>
                                            <div class="my-2 text-secondary video-duration" style="font-size: 0.9em;">{{ single_video['duration'] }}</div>
                                        </div>
                                        <div class="align-self-start flex-grow-1" style="text-align: right;">
                                            <span class="text-secondary" style="font-size: 0.8em;">{{ single_video['upload_idx'] }}</span><br />
                                            {% if single_video['local_id'] %}
                                                <span><i class="iconfont icon-archive text-success"></i></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <ul class="pagination justify-content-center mt-5">
                    <li class="page-item"><a class="page-link" href="{{ url_for('channels.single_channel', channel_id=channel_info['channel_id'], page=1) }}">&lt;&lt;</a></li>
                    {% if pagination.active_page > 1 %}
                        <li class="page-item"><a class="page-link" href="{{ pagination.links[pagination.list.index(pagination.active_page)-1] }}">&lt;</a></li>
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#">&lt;</a></li>
                    {% endif %}

                    {% for i in range(pagination.list|length) %}
                        <li class="page-item {% if pagination.active_page==pagination.list[i] %}active{% endif %}"><a class="page-link" href="{{ pagination.links[i] }}">{{ pagination.list[i] }}</a></li>
                    {% endfor %}

                    {% if pagination.active_page != page_num %}
                        <li class="page-item"><a class="page-link" href="{{ pagination.links[pagination.list.index(pagination.active_page)+1] }}">&gt;</a></li>
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#">&gt;</a></l>
                    {% endif %}
                        
                    <li class="page-item"><a class="page-link" href="{{ url_for('channels.single_channel', channel_id=channel_info['channel_id'], page=page_num) }}">&gt;&gt;</a></li>
                </ul>
            </div>

            <div class="tab-pane container fade" id="channel-stats">
                <div class="mt-3">
                    <div class="d-flex justify-content-end">
                        <div class="btn-group btn-group-sm">
                            <button id="stats-fit" type="button" class="btn btn-outline-secondary stats-filter">Fit</button>
                            <button id="stats-30" type="button" class="btn btn-outline-secondary stats-filter">30 Days</button>
                            <button id="stats-90" type="button" class="btn btn-outline-secondary stats-filter">90 Days</button>
                            <button id="stats-365" type="button" class="btn btn-outline-secondary stats-filter">365 Days</button>
                        </div>
                    </div>
                <div class="mt-3">
                    <div class="chart-title">Collaborations</div>
                    <canvas id="talent-chart" width="400"></canvas>
                </div>
                <div class="mt-5">
                    <div class="chart-title">Stream Types</div>
                    <canvas id="tag-chart" width="400" height="400"></canvas>
                </div>
                <div class="mt-5">
                    <div class="chart-title">Number of Videos Uploaded per Week</div>
                    <canvas id="num-stats" width="400" height="200"></canvas>
                </div>
                <div class="mt-5">
                    <div class="chart-title">Total Length of Videos Uploaded per Week (Hours)</div>
                    <canvas id="duration-stats" width="400" height="200"></canvas>
                </div>
                <div class="mt-5 mb-5">
                    <div class="chart-title">Video Lengths Distribution (Minutes)</div>
                    <canvas id="duration-distr" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

    </div>


    <div class="col-sm-1"></div>

</div>

{% if g.user %}
<!-- Settings modal box-->
<div class="modal fade" id="channel-setting-modal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">Update Channel</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div>
                    {% for message in get_flashed_messages() %}
                        <div class="alert alert-info">
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>

                <div class="mx-5 pb-3 border-bottom">
                    <form method="post" action="{{ url_for('channels.edit_checkpoint', channel_id=channel_info['channel_id']) }}">
                        <div class="mb-3 mt-3">
                            <label for="checkpoint_idx" class="form-label">New upload index: </label>
                            <input class="form-control" id="checkpoint_idx" type="number" name="checkpoint_idx" />
                        </div>
                        <div class="mb-3">
                            <label for="video_id" class="form-label">New video ID: </label>
                            <input class="form-control" id="video_id" type="text" name="video_id" />
                        </div>
                        <div class="mb-3">
                            <label for="offset" class="form-label">Offset: </label>
                            <input class="form-control" id="offset" name="offset" type="number" />
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-success">Apply</button>
                        </div>
                    </form>
                </div>

                <div class="mx-5 pb-3">
                    <form method="post" action="{{ url_for('channels.edit_talent', channel_id=channel_info['channel_id']) }}">
                        <div class="mb-3 mt-3">
                            <label for="talent_name" class="form-label">New talent name: </label>
                            <input class="form-control" id="talent_name" type="text" name="talent_name" />
                        </div>
                        <div style="text-align: right;">
                            <button type="button" class="btn btn-success me-2" onclick="location.assign('{{ url_for('channels.add_talent_name', channel_id=channel_info['channel_id']) }}')">Auto add talent</button>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="delete-channel-btn">Delete Channel</button>
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
            </div>

        </div>
    </div>
</div>
{% endif %}

{% endblock %} 


{% block end_body %}
<script src="{{ url_for('static', filename='scripts/single_channel.js') }}"></script>
<script>
    let delete_channel_btn = $('#delete-channel-btn');
    delete_channel_btn.on('click', function () {
        if (confirm('Are you sure you want to delete this channel? ')) {
        location.assign('{{ url_for("channels.delete_channel", channel_id=channel_info["channel_id"]) }}');
        }
    });
</script>
{% endblock %}